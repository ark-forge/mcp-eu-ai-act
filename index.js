#!/usr/bin/env node
const { spawn } = require("child_process");
const fs = require("fs");
const path = require("path");
const os = require("os");

const SERVER_PY_B64 = "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKTUNQIFNlcnZlcjogRVUgQUkgQWN0IENvbXBsaWFuY2UgQ2hlY2tlcgpTY2FucyBwcm9qZWN0cyB0byBkZXRlY3QgQUkgbW9kZWwgdXNhZ2UgYW5kIHZlcmlmeSBFVSBBSSBBY3QgY29tcGxpYW5jZQoiIiIKCmltcG9ydCBvcwppbXBvcnQgcmUKaW1wb3J0IGpzb24KaW1wb3J0IGxvZ2dpbmcKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBBbnksIE9wdGlvbmFsCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lem9uZQpmcm9tIGVudW0gaW1wb3J0IEVudW0KCmZyb20gbWNwLnNlcnZlci5mYXN0bWNwIGltcG9ydCBGYXN0TUNQCmZyb20gc21pdGhlcnkuZGVjb3JhdG9ycyBpbXBvcnQgc21pdGhlcnkKCmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKF9fbmFtZV9fKQoKIyBQYXR0ZXJucyBmb3IgZGV0ZWN0aW5nIEFJIG1vZGVsIHVzYWdlCkFJX01PREVMX1BBVFRFUk5TID0gewogICAgIm9wZW5haSI6IFsKICAgICAgICByIm9wZW5haVwuQ2hhdENvbXBsZXRpb24iLAogICAgICAgIHIib3BlbmFpXC5Db21wbGV0aW9uIiwKICAgICAgICByImZyb20gb3BlbmFpIGltcG9ydCIsCiAgICAgICAgciJpbXBvcnQgb3BlbmFpIiwKICAgICAgICByImdwdC0zXC41IiwKICAgICAgICByImdwdC00IiwKICAgICAgICByInRleHQtZGF2aW5jaSIsCiAgICBdLAogICAgImFudGhyb3BpYyI6IFsKICAgICAgICByImZyb20gYW50aHJvcGljIGltcG9ydCIsCiAgICAgICAgciJpbXBvcnQgYW50aHJvcGljIiwKICAgICAgICByImNsYXVkZS0iLAogICAgICAgIHIiQW50aHJvcGljXChcKSIsCiAgICAgICAgciJtZXNzYWdlc1wuY3JlYXRlIiwKICAgIF0sCiAgICAiaHVnZ2luZ2ZhY2UiOiBbCiAgICAgICAgciJmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQiLAogICAgICAgIHIiQXV0b01vZGVsIiwKICAgICAgICByIkF1dG9Ub2tlbml6ZXIiLAogICAgICAgIHIicGlwZWxpbmVcKCIsCiAgICAgICAgciJodWdnaW5nZmFjZV9odWIiLAogICAgXSwKICAgICJ0ZW5zb3JmbG93IjogWwogICAgICAgIHIiaW1wb3J0IHRlbnNvcmZsb3ciLAogICAgICAgIHIiZnJvbSB0ZW5zb3JmbG93IGltcG9ydCIsCiAgICAgICAgciJ0Zlwua2VyYXMiLAogICAgICAgIHIiXC5oNSQiLCAgIyBtb2RlbCBmaWxlcwogICAgXSwKICAgICJweXRvcmNoIjogWwogICAgICAgIHIiaW1wb3J0IHRvcmNoIiwKICAgICAgICByImZyb20gdG9yY2ggaW1wb3J0IiwKICAgICAgICByIm5uXC5Nb2R1bGUiLAogICAgICAgIHIiXC5wdCQiLCAgIyBtb2RlbCBmaWxlcwogICAgICAgIHIiXC5wdGgkIiwKICAgIF0sCiAgICAibGFuZ2NoYWluIjogWwogICAgICAgIHIiZnJvbSBsYW5nY2hhaW4gaW1wb3J0IiwKICAgICAgICByImltcG9ydCBsYW5nY2hhaW4iLAogICAgICAgIHIiTExNQ2hhaW4iLAogICAgICAgIHIiQ2hhdE9wZW5BSSIsCiAgICBdLAp9CgojIEVVIEFJIEFjdCAtIFJpc2sgY2F0ZWdvcmllcwpSSVNLX0NBVEVHT1JJRVMgPSB7CiAgICAidW5hY2NlcHRhYmxlIjogewogICAgICAgICJkZXNjcmlwdGlvbiI6ICJQcm9oaWJpdGVkIHN5c3RlbXMgKGJlaGF2aW9yYWwgbWFuaXB1bGF0aW9uLCBzb2NpYWwgc2NvcmluZywgbWFzcyBiaW9tZXRyaWMgc3VydmVpbGxhbmNlKSIsCiAgICAgICAgInJlcXVpcmVtZW50cyI6IFsiUHJvaGliaXRlZCBzeXN0ZW0gLSBEbyBub3QgZGVwbG95Il0sCiAgICB9LAogICAgImhpZ2giOiB7CiAgICAgICAgImRlc2NyaXB0aW9uIjogIkhpZ2gtcmlzayBzeXN0ZW1zIChyZWNydWl0bWVudCwgY3JlZGl0IHNjb3JpbmcsIGxhdyBlbmZvcmNlbWVudCkiLAogICAgICAgICJyZXF1aXJlbWVudHMiOiBbCiAgICAgICAgICAgICJDb21wbGV0ZSB0ZWNobmljYWwgZG9jdW1lbnRhdGlvbiIsCiAgICAgICAgICAgICJSaXNrIG1hbmFnZW1lbnQgc3lzdGVtIiwKICAgICAgICAgICAgIkRhdGEgcXVhbGl0eSBhbmQgZ292ZXJuYW5jZSIsCiAgICAgICAgICAgICJUcmFuc3BhcmVuY3kgYW5kIHVzZXIgaW5mb3JtYXRpb24iLAogICAgICAgICAgICAiSHVtYW4gb3ZlcnNpZ2h0IiwKICAgICAgICAgICAgIlJvYnVzdG5lc3MsIGFjY3VyYWN5IGFuZCBjeWJlcnNlY3VyaXR5IiwKICAgICAgICAgICAgIlF1YWxpdHkgbWFuYWdlbWVudCBzeXN0ZW0iLAogICAgICAgICAgICAiUmVnaXN0cmF0aW9uIGluIEVVIGRhdGFiYXNlIiwKICAgICAgICBdLAogICAgfSwKICAgICJsaW1pdGVkIjogewogICAgICAgICJkZXNjcmlwdGlvbiI6ICJMaW1pdGVkLXJpc2sgc3lzdGVtcyAoY2hhdGJvdHMsIGRlZXBmYWtlcykiLAogICAgICAgICJyZXF1aXJlbWVudHMiOiBbCiAgICAgICAgICAgICJUcmFuc3BhcmVuY3kgb2JsaWdhdGlvbnMiLAogICAgICAgICAgICAiQ2xlYXIgdXNlciBpbmZvcm1hdGlvbiBhYm91dCBBSSBpbnRlcmFjdGlvbiIsCiAgICAgICAgICAgICJBSS1nZW5lcmF0ZWQgY29udGVudCBtYXJraW5nIiwKICAgICAgICBdLAogICAgfSwKICAgICJtaW5pbWFsIjogewogICAgICAgICJkZXNjcmlwdGlvbiI6ICJNaW5pbWFsLXJpc2sgc3lzdGVtcyAoc3BhbSBmaWx0ZXJzLCB2aWRlbyBnYW1lcykiLAogICAgICAgICJyZXF1aXJlbWVudHMiOiBbCiAgICAgICAgICAgICJObyBzcGVjaWZpYyBvYmxpZ2F0aW9ucyIsCiAgICAgICAgICAgICJWb2x1bnRhcnkgY29kZSBvZiBjb25kdWN0IGVuY291cmFnZWQiLAogICAgICAgIF0sCiAgICB9LAp9CgoKIyBTZWN1cml0eTogZGlyZWN0b3JpZXMgdGhhdCBtdXN0IE5FVkVSIGJlIHNjYW5uZWQKQkxPQ0tFRF9QQVRIUyA9IFsKICAgICIvb3B0L2NsYXVkZS1jZW8iLAogICAgIi9ldGMiLAogICAgIi9yb290IiwKICAgICIvaG9tZSIsCiAgICAiL3ZhciIsCiAgICAiL3Byb2MiLAogICAgIi9zeXMiLAogICAgIi9kZXYiLAogICAgIi9ydW4iLAogICAgIi9ib290IiwKICAgICIvdXNyIiwKICAgICIvYmluIiwKICAgICIvc2JpbiIsCiAgICAiL2xpYiIsCiAgICAiL3NuYXAiLAogICAgIi9tbnQiLAogICAgIi9tZWRpYSIsCl0KCiMgU2VjdXJpdHk6IG1heCBmaWxlcyB0byBzY2FuIChwcmV2ZW50IERvUykKTUFYX0ZJTEVTX1RPX1NDQU4gPSA1MDAwCk1BWF9GSUxFX1NJWkVfQllURVMgPSAxXzAwMF8wMDAgICMgMU1CCgoKZGVmIF92YWxpZGF0ZV9wcm9qZWN0X3BhdGgocHJvamVjdF9wYXRoOiBzdHIpIC0+IHR1cGxlW2Jvb2wsIHN0cl06CiAgICAiIiJWYWxpZGF0ZSB0aGF0IGEgcHJvamVjdCBwYXRoIGlzIHNhZmUgdG8gc2Nhbi4KCiAgICBSZXR1cm5zOgogICAgICAgIChpc19zYWZlLCBlcnJvcl9tZXNzYWdlKQogICAgIiIiCiAgICB0cnk6CiAgICAgICAgcmVzb2x2ZWQgPSBQYXRoKHByb2plY3RfcGF0aCkucmVzb2x2ZSgpCiAgICBleGNlcHQgKFZhbHVlRXJyb3IsIE9TRXJyb3IpOgogICAgICAgIHJldHVybiBGYWxzZSwgZiJJbnZhbGlkIHBhdGg6IHtwcm9qZWN0X3BhdGh9IgoKICAgIHJlc29sdmVkX3N0ciA9IHN0cihyZXNvbHZlZCkKCiAgICAjIEJsb2NrIGFic29sdXRlIHBhdGhzIHRvIHNlbnNpdGl2ZSBkaXJlY3RvcmllcwogICAgZm9yIGJsb2NrZWQgaW4gQkxPQ0tFRF9QQVRIUzoKICAgICAgICBpZiByZXNvbHZlZF9zdHIgPT0gYmxvY2tlZCBvciByZXNvbHZlZF9zdHIuc3RhcnRzd2l0aChibG9ja2VkICsgIi8iKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCBmIkFjY2VzcyBkZW5pZWQ6IHNjYW5uaW5nIHtibG9ja2VkfSBpcyBub3QgYWxsb3dlZCBmb3Igc2VjdXJpdHkgcmVhc29ucyIKCiAgICAjIEJsb2NrIHN5bWxpbmtzIHRoYXQgZXNjYXBlIHRvIGJsb2NrZWQgcGF0aHMKICAgIGlmIHJlc29sdmVkICE9IFBhdGgocHJvamVjdF9wYXRoKToKICAgICAgICBmb3IgYmxvY2tlZCBpbiBCTE9DS0VEX1BBVEhTOgogICAgICAgICAgICBpZiByZXNvbHZlZF9zdHIuc3RhcnRzd2l0aChibG9ja2VkICsgIi8iKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSwgZiJBY2Nlc3MgZGVuaWVkOiBzeW1saW5rIHJlc29sdmVzIHRvIGJsb2NrZWQgcGF0aCIKCiAgICByZXR1cm4gVHJ1ZSwgIiIKCgpjbGFzcyBFVUFJQWN0Q2hlY2tlcjoKICAgICIiIkVVIEFJIEFjdCBjb21wbGlhbmNlIGNoZWNrZXIiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJvamVjdF9wYXRoOiBzdHIpOgogICAgICAgIHNlbGYucHJvamVjdF9wYXRoID0gUGF0aChwcm9qZWN0X3BhdGgpCiAgICAgICAgc2VsZi5kZXRlY3RlZF9tb2RlbHMgPSB7fQogICAgICAgIHNlbGYuZmlsZXNfc2Nhbm5lZCA9IDAKICAgICAgICBzZWxmLmFpX2ZpbGVzID0gW10KCiAgICBkZWYgc2Nhbl9wcm9qZWN0KHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIlNjYW4gdGhlIHByb2plY3QgdG8gZGV0ZWN0IEFJIG1vZGVsIHVzYWdlIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIlNjYW5uaW5nIHByb2plY3Q6ICVzIiwgc2VsZi5wcm9qZWN0X3BhdGgpCgogICAgICAgICMgU2VjdXJpdHk6IHZhbGlkYXRlIHBhdGggYmVmb3JlIHNjYW5uaW5nCiAgICAgICAgaXNfc2FmZSwgZXJyb3JfbXNnID0gX3ZhbGlkYXRlX3Byb2plY3RfcGF0aChzdHIoc2VsZi5wcm9qZWN0X3BhdGgpKQogICAgICAgIGlmIG5vdCBpc19zYWZlOgogICAgICAgICAgICByZXR1cm4geyJlcnJvciI6IGVycm9yX21zZywgImRldGVjdGVkX21vZGVscyI6IHt9fQoKICAgICAgICBpZiBub3Qgc2VsZi5wcm9qZWN0X3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAiZXJyb3IiOiBmIlByb2plY3QgcGF0aCBkb2VzIG5vdCBleGlzdDoge3NlbGYucHJvamVjdF9wYXRofSIsCiAgICAgICAgICAgICAgICAiZGV0ZWN0ZWRfbW9kZWxzIjoge30sCiAgICAgICAgICAgIH0KCiAgICAgICAgIyBGaWxlIGV4dGVuc2lvbnMgdG8gc2NhbgogICAgICAgIGNvZGVfZXh0ZW5zaW9ucyA9IHsiLnB5IiwgIi5qcyIsICIudHMiLCAiLmphdmEiLCAiLmdvIiwgIi5ycyIsICIuY3BwIiwgIi5jIn0KCiAgICAgICAgZm9yIGZpbGVfcGF0aCBpbiBzZWxmLnByb2plY3RfcGF0aC5yZ2xvYigiKiIpOgogICAgICAgICAgICBpZiBzZWxmLmZpbGVzX3NjYW5uZWQgPj0gTUFYX0ZJTEVTX1RPX1NDQU46CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiTWF4IGZpbGVzIGxpbWl0IHJlYWNoZWQgKCVkKSIsIE1BWF9GSUxFU19UT19TQ0FOKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgaWYgZmlsZV9wYXRoLmlzX2ZpbGUoKSBhbmQgZmlsZV9wYXRoLnN1ZmZpeCBpbiBjb2RlX2V4dGVuc2lvbnM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgZmlsZV9wYXRoLnN0YXQoKS5zdF9zaXplID4gTUFYX0ZJTEVfU0laRV9CWVRFUzoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgICMgU2tpcCBvdmVyc2l6ZWQgZmlsZXMKICAgICAgICAgICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBzZWxmLl9zY2FuX2ZpbGUoZmlsZV9wYXRoKQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAiZmlsZXNfc2Nhbm5lZCI6IHNlbGYuZmlsZXNfc2Nhbm5lZCwKICAgICAgICAgICAgImFpX2ZpbGVzIjogc2VsZi5haV9maWxlcywKICAgICAgICAgICAgImRldGVjdGVkX21vZGVscyI6IHNlbGYuZGV0ZWN0ZWRfbW9kZWxzLAogICAgICAgIH0KCiAgICBkZWYgX3NjYW5fZmlsZShzZWxmLCBmaWxlX3BhdGg6IFBhdGgpOgogICAgICAgICIiIlNjYW4gYSBmaWxlIGZvciBBSSBwYXR0ZXJucyIiIgogICAgICAgIHNlbGYuZmlsZXNfc2Nhbm5lZCArPSAxCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb250ZW50ID0gZmlsZV9wYXRoLnJlYWRfdGV4dChlbmNvZGluZz0idXRmLTgiLCBlcnJvcnM9Imlnbm9yZSIpCgogICAgICAgICAgICBmaWxlX2RldGVjdGlvbnMgPSBbXQogICAgICAgICAgICBmb3IgZnJhbWV3b3JrLCBwYXR0ZXJucyBpbiBBSV9NT0RFTF9QQVRURVJOUy5pdGVtcygpOgogICAgICAgICAgICAgICAgZm9yIHBhdHRlcm4gaW4gcGF0dGVybnM6CiAgICAgICAgICAgICAgICAgICAgaWYgcmUuc2VhcmNoKHBhdHRlcm4sIGNvbnRlbnQsIHJlLklHTk9SRUNBU0UpOgogICAgICAgICAgICAgICAgICAgICAgICBmaWxlX2RldGVjdGlvbnMuYXBwZW5kKGZyYW1ld29yaykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZnJhbWV3b3JrIG5vdCBpbiBzZWxmLmRldGVjdGVkX21vZGVsczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGV0ZWN0ZWRfbW9kZWxzW2ZyYW1ld29ya10gPSBbXQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRldGVjdGVkX21vZGVsc1tmcmFtZXdvcmtdLmFwcGVuZChzdHIoZmlsZV9wYXRoLnJlbGF0aXZlX3RvKHNlbGYucHJvamVjdF9wYXRoKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrICAjIE9uZSBkZXRlY3Rpb24gcGVyIGZyYW1ld29yayBwZXIgZmlsZQoKICAgICAgICAgICAgaWYgZmlsZV9kZXRlY3Rpb25zOgogICAgICAgICAgICAgICAgc2VsZi5haV9maWxlcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICJmaWxlIjogc3RyKGZpbGVfcGF0aC5yZWxhdGl2ZV90byhzZWxmLnByb2plY3RfcGF0aCkpLAogICAgICAgICAgICAgICAgICAgICJmcmFtZXdvcmtzIjogbGlzdChzZXQoZmlsZV9kZXRlY3Rpb25zKSksCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJFcnJvciBzY2FubmluZyAlczogJXMiLCBmaWxlX3BhdGgsIGUpCgogICAgZGVmIGNoZWNrX2NvbXBsaWFuY2Uoc2VsZiwgcmlza19jYXRlZ29yeTogc3RyID0gImxpbWl0ZWQiKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiJDaGVjayBFVSBBSSBBY3QgY29tcGxpYW5jZSBmb3IgYSBnaXZlbiByaXNrIGNhdGVnb3J5IiIiCiAgICAgICAgaWYgcmlza19jYXRlZ29yeSBub3QgaW4gUklTS19DQVRFR09SSUVTOgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImVycm9yIjogZiJJbnZhbGlkIHJpc2sgY2F0ZWdvcnk6IHtyaXNrX2NhdGVnb3J5fS4gVmFsaWQ6IHtsaXN0KFJJU0tfQ0FURUdPUklFUy5rZXlzKCkpfSIsCiAgICAgICAgICAgIH0KCiAgICAgICAgY2F0ZWdvcnlfaW5mbyA9IFJJU0tfQ0FURUdPUklFU1tyaXNrX2NhdGVnb3J5XQogICAgICAgIHJlcXVpcmVtZW50cyA9IGNhdGVnb3J5X2luZm9bInJlcXVpcmVtZW50cyJdCgogICAgICAgIGNvbXBsaWFuY2VfY2hlY2tzID0gewogICAgICAgICAgICAicmlza19jYXRlZ29yeSI6IHJpc2tfY2F0ZWdvcnksCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IGNhdGVnb3J5X2luZm9bImRlc2NyaXB0aW9uIl0sCiAgICAgICAgICAgICJyZXF1aXJlbWVudHMiOiByZXF1aXJlbWVudHMsCiAgICAgICAgICAgICJjb21wbGlhbmNlX3N0YXR1cyI6IHt9LAogICAgICAgIH0KCiAgICAgICAgIyBCYXNpYyBjb21wbGlhbmNlIGNoZWNrcwogICAgICAgIGRvY3NfcGF0aCA9IHNlbGYucHJvamVjdF9wYXRoIC8gImRvY3MiCiAgICAgICAgcmVhZG1lX2V4aXN0cyA9IChzZWxmLnByb2plY3RfcGF0aCAvICJSRUFETUUubWQiKS5leGlzdHMoKQoKICAgICAgICBpZiByaXNrX2NhdGVnb3J5ID09ICJoaWdoIjoKICAgICAgICAgICAgY29tcGxpYW5jZV9jaGVja3NbImNvbXBsaWFuY2Vfc3RhdHVzIl0gPSB7CiAgICAgICAgICAgICAgICAidGVjaG5pY2FsX2RvY3VtZW50YXRpb24iOiBzZWxmLl9jaGVja190ZWNobmljYWxfZG9jcygpLAogICAgICAgICAgICAgICAgInJpc2tfbWFuYWdlbWVudCI6IHNlbGYuX2NoZWNrX2ZpbGVfZXhpc3RzKCJSSVNLX01BTkFHRU1FTlQubWQiKSwKICAgICAgICAgICAgICAgICJ0cmFuc3BhcmVuY3kiOiBzZWxmLl9jaGVja19maWxlX2V4aXN0cygiVFJBTlNQQVJFTkNZLm1kIikgb3IgcmVhZG1lX2V4aXN0cywKICAgICAgICAgICAgICAgICJkYXRhX2dvdmVybmFuY2UiOiBzZWxmLl9jaGVja19maWxlX2V4aXN0cygiREFUQV9HT1ZFUk5BTkNFLm1kIiksCiAgICAgICAgICAgICAgICAiaHVtYW5fb3ZlcnNpZ2h0Ijogc2VsZi5fY2hlY2tfZmlsZV9leGlzdHMoIkhVTUFOX09WRVJTSUdIVC5tZCIpLAogICAgICAgICAgICAgICAgInJvYnVzdG5lc3MiOiBzZWxmLl9jaGVja19maWxlX2V4aXN0cygiUk9CVVNUTkVTUy5tZCIpLAogICAgICAgICAgICB9CiAgICAgICAgZWxpZiByaXNrX2NhdGVnb3J5ID09ICJsaW1pdGVkIjoKICAgICAgICAgICAgY29tcGxpYW5jZV9jaGVja3NbImNvbXBsaWFuY2Vfc3RhdHVzIl0gPSB7CiAgICAgICAgICAgICAgICAidHJhbnNwYXJlbmN5IjogcmVhZG1lX2V4aXN0cyBvciBzZWxmLl9jaGVja19maWxlX2V4aXN0cygiVFJBTlNQQVJFTkNZLm1kIiksCiAgICAgICAgICAgICAgICAidXNlcl9kaXNjbG9zdXJlIjogc2VsZi5fY2hlY2tfYWlfZGlzY2xvc3VyZSgpLAogICAgICAgICAgICAgICAgImNvbnRlbnRfbWFya2luZyI6IHNlbGYuX2NoZWNrX2NvbnRlbnRfbWFya2luZygpLAogICAgICAgICAgICB9CiAgICAgICAgZWxpZiByaXNrX2NhdGVnb3J5ID09ICJtaW5pbWFsIjoKICAgICAgICAgICAgY29tcGxpYW5jZV9jaGVja3NbImNvbXBsaWFuY2Vfc3RhdHVzIl0gPSB7CiAgICAgICAgICAgICAgICAiYmFzaWNfZG9jdW1lbnRhdGlvbiI6IHJlYWRtZV9leGlzdHMsCiAgICAgICAgICAgIH0KCiAgICAgICAgIyBDYWxjdWxhdGUgY29tcGxpYW5jZSBzY29yZQogICAgICAgIHRvdGFsX2NoZWNrcyA9IGxlbihjb21wbGlhbmNlX2NoZWNrc1siY29tcGxpYW5jZV9zdGF0dXMiXSkKICAgICAgICBwYXNzZWRfY2hlY2tzID0gc3VtKDEgZm9yIHYgaW4gY29tcGxpYW5jZV9jaGVja3NbImNvbXBsaWFuY2Vfc3RhdHVzIl0udmFsdWVzKCkgaWYgdikKICAgICAgICBjb21wbGlhbmNlX2NoZWNrc1siY29tcGxpYW5jZV9zY29yZSJdID0gZiJ7cGFzc2VkX2NoZWNrc30ve3RvdGFsX2NoZWNrc30iCiAgICAgICAgY29tcGxpYW5jZV9jaGVja3NbImNvbXBsaWFuY2VfcGVyY2VudGFnZSJdID0gcm91bmQoKHBhc3NlZF9jaGVja3MgLyB0b3RhbF9jaGVja3MpICogMTAwLCAxKSBpZiB0b3RhbF9jaGVja3MgPiAwIGVsc2UgMAoKICAgICAgICByZXR1cm4gY29tcGxpYW5jZV9jaGVja3MKCiAgICBkZWYgX2NoZWNrX3RlY2huaWNhbF9kb2NzKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiQ2hlY2sgZm9yIHRlY2huaWNhbCBkb2N1bWVudGF0aW9uIiIiCiAgICAgICAgZG9jcyA9IFsiUkVBRE1FLm1kIiwgIkFSQ0hJVEVDVFVSRS5tZCIsICJBUEkubWQiLCAiZG9jcy8iXQogICAgICAgIHJldHVybiBhbnkoKHNlbGYucHJvamVjdF9wYXRoIC8gZG9jKS5leGlzdHMoKSBmb3IgZG9jIGluIGRvY3MpCgogICAgZGVmIF9jaGVja19maWxlX2V4aXN0cyhzZWxmLCBmaWxlbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIkNoZWNrIGlmIGEgZmlsZSBleGlzdHMiIiIKICAgICAgICByZXR1cm4gKHNlbGYucHJvamVjdF9wYXRoIC8gZmlsZW5hbWUpLmV4aXN0cygpIG9yIChzZWxmLnByb2plY3RfcGF0aCAvICJkb2NzIiAvIGZpbGVuYW1lKS5leGlzdHMoKQoKICAgIGRlZiBfY2hlY2tfYWlfZGlzY2xvc3VyZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIkNoZWNrIGlmIHRoZSBwcm9qZWN0IGNsZWFybHkgZGlzY2xvc2VzIEFJIHVzYWdlIiIiCiAgICAgICAgcmVhZG1lX3BhdGggPSBzZWxmLnByb2plY3RfcGF0aCAvICJSRUFETUUubWQiCiAgICAgICAgaWYgcmVhZG1lX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgIGNvbnRlbnQgPSByZWFkbWVfcGF0aC5yZWFkX3RleHQoZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJpZ25vcmUiKS5sb3dlcigpCiAgICAgICAgICAgIGFpX2tleXdvcmRzID0gWyJhaSIsICJhcnRpZmljaWFsIGludGVsbGlnZW5jZSIsICJpbnRlbGxpZ2VuY2UgYXJ0aWZpY2llbGxlIiwgIm1hY2hpbmUgbGVhcm5pbmciLCAiZGVlcCBsZWFybmluZyIsICJncHQiLCAiY2xhdWRlIiwgImxsbSJdCiAgICAgICAgICAgIHJldHVybiBhbnkoa2V5d29yZCBpbiBjb250ZW50IGZvciBrZXl3b3JkIGluIGFpX2tleXdvcmRzKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfY2hlY2tfY29udGVudF9tYXJraW5nKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiQ2hlY2sgaWYgZ2VuZXJhdGVkIGNvbnRlbnQgaXMgcHJvcGVybHkgbWFya2VkIiIiCiAgICAgICAgbWFya2VycyA9IFsKICAgICAgICAgICAgImdlbmVyYXRlZCBieSBhaSIsCiAgICAgICAgICAgICJnw6luw6lyw6kgcGFyIGlhIiwKICAgICAgICAgICAgImFpLWdlbmVyYXRlZCIsCiAgICAgICAgICAgICJtYWNoaW5lLWdlbmVyYXRlZCIsCiAgICAgICAgXQogICAgICAgIGZvciBmaWxlX3BhdGggaW4gc2VsZi5wcm9qZWN0X3BhdGgucmdsb2IoIioucHkiKToKICAgICAgICAgICAgaWYgZmlsZV9wYXRoLmlzX2ZpbGUoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZmlsZV9wYXRoLnJlYWRfdGV4dChlbmNvZGluZz0idXRmLTgiLCBlcnJvcnM9Imlnbm9yZSIpLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICBpZiBhbnkobWFya2VyIGluIGNvbnRlbnQgZm9yIG1hcmtlciBpbiBtYXJrZXJzKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdlbmVyYXRlX3JlcG9ydChzZWxmLCBzY2FuX3Jlc3VsdHM6IERpY3QsIGNvbXBsaWFuY2VfcmVzdWx0czogRGljdCkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiR2VuZXJhdGUgYSBjb21wbGV0ZSBjb21wbGlhbmNlIHJlcG9ydCIiIgogICAgICAgIHJlcG9ydCA9IHsKICAgICAgICAgICAgInJlcG9ydF9kYXRlIjogZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YykuaXNvZm9ybWF0KCksCiAgICAgICAgICAgICJwcm9qZWN0X3BhdGgiOiBzdHIoc2VsZi5wcm9qZWN0X3BhdGgpLAogICAgICAgICAgICAic2Nhbl9zdW1tYXJ5IjogewogICAgICAgICAgICAgICAgImZpbGVzX3NjYW5uZWQiOiBzY2FuX3Jlc3VsdHMuZ2V0KCJmaWxlc19zY2FubmVkIiwgMCksCiAgICAgICAgICAgICAgICAiYWlfZmlsZXNfZGV0ZWN0ZWQiOiBsZW4oc2Nhbl9yZXN1bHRzLmdldCgiYWlfZmlsZXMiLCBbXSkpLAogICAgICAgICAgICAgICAgImZyYW1ld29ya3NfZGV0ZWN0ZWQiOiBsaXN0KHNjYW5fcmVzdWx0cy5nZXQoImRldGVjdGVkX21vZGVscyIsIHt9KS5rZXlzKCkpLAogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29tcGxpYW5jZV9zdW1tYXJ5IjogewogICAgICAgICAgICAgICAgInJpc2tfY2F0ZWdvcnkiOiBjb21wbGlhbmNlX3Jlc3VsdHMuZ2V0KCJyaXNrX2NhdGVnb3J5IiwgInVua25vd24iKSwKICAgICAgICAgICAgICAgICJjb21wbGlhbmNlX3Njb3JlIjogY29tcGxpYW5jZV9yZXN1bHRzLmdldCgiY29tcGxpYW5jZV9zY29yZSIsICIwLzAiKSwKICAgICAgICAgICAgICAgICJjb21wbGlhbmNlX3BlcmNlbnRhZ2UiOiBjb21wbGlhbmNlX3Jlc3VsdHMuZ2V0KCJjb21wbGlhbmNlX3BlcmNlbnRhZ2UiLCAwKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImRldGFpbGVkX2ZpbmRpbmdzIjogewogICAgICAgICAgICAgICAgImRldGVjdGVkX21vZGVscyI6IHNjYW5fcmVzdWx0cy5nZXQoImRldGVjdGVkX21vZGVscyIsIHt9KSwKICAgICAgICAgICAgICAgICJjb21wbGlhbmNlX2NoZWNrcyI6IGNvbXBsaWFuY2VfcmVzdWx0cy5nZXQoImNvbXBsaWFuY2Vfc3RhdHVzIiwge30pLAogICAgICAgICAgICAgICAgInJlcXVpcmVtZW50cyI6IGNvbXBsaWFuY2VfcmVzdWx0cy5nZXQoInJlcXVpcmVtZW50cyIsIFtdKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlY29tbWVuZGF0aW9ucyI6IHNlbGYuX2dlbmVyYXRlX3JlY29tbWVuZGF0aW9ucyhjb21wbGlhbmNlX3Jlc3VsdHMpLAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlcG9ydAoKICAgIGRlZiBfZ2VuZXJhdGVfcmVjb21tZW5kYXRpb25zKHNlbGYsIGNvbXBsaWFuY2VfcmVzdWx0czogRGljdCkgLT4gTGlzdFtzdHJdOgogICAgICAgICIiIkdlbmVyYXRlIHJlY29tbWVuZGF0aW9ucyBiYXNlZCBvbiBjb21wbGlhbmNlIHJlc3VsdHMiIiIKICAgICAgICByZWNvbW1lbmRhdGlvbnMgPSBbXQogICAgICAgIGNvbXBsaWFuY2Vfc3RhdHVzID0gY29tcGxpYW5jZV9yZXN1bHRzLmdldCgiY29tcGxpYW5jZV9zdGF0dXMiLCB7fSkKCiAgICAgICAgZm9yIGNoZWNrLCBwYXNzZWQgaW4gY29tcGxpYW5jZV9zdGF0dXMuaXRlbXMoKToKICAgICAgICAgICAgaWYgbm90IHBhc3NlZDoKICAgICAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5hcHBlbmQoZiJNSVNTSU5HOiBDcmVhdGUgZG9jdW1lbnRhdGlvbiBmb3I6IHtjaGVjay5yZXBsYWNlKCdfJywgJyAnKS50aXRsZSgpfSIpCgogICAgICAgIGlmIG5vdCByZWNvbW1lbmRhdGlvbnM6CiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5hcHBlbmQoIkFsbCBiYXNpYyBjaGVja3MgcGFzc2VkIikKCiAgICAgICAgcmlza19jYXRlZ29yeSA9IGNvbXBsaWFuY2VfcmVzdWx0cy5nZXQoInJpc2tfY2F0ZWdvcnkiLCAibGltaXRlZCIpCiAgICAgICAgaWYgcmlza19jYXRlZ29yeSA9PSAiaGlnaCI6CiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5hcHBlbmQoIldBUk5JTkc6IEhpZ2gtcmlzayBzeXN0ZW0gLSBFVSBkYXRhYmFzZSByZWdpc3RyYXRpb24gcmVxdWlyZWQgYmVmb3JlIGRlcGxveW1lbnQiKQogICAgICAgIGVsaWYgcmlza19jYXRlZ29yeSA9PSAibGltaXRlZCI6CiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5hcHBlbmQoIklORk86IExpbWl0ZWQtcmlzayBzeXN0ZW0gLSBFbnN1cmUgZnVsbCB0cmFuc3BhcmVuY3kgY29tcGxpYW5jZSIpCgogICAgICAgIHJldHVybiByZWNvbW1lbmRhdGlvbnMKCgpjbGFzcyBSaXNrQ2F0ZWdvcnkoc3RyLCBFbnVtKToKICAgICIiIkVVIEFJIEFjdCByaXNrIGNhdGVnb3JpZXMiIiIKICAgIHVuYWNjZXB0YWJsZSA9ICJ1bmFjY2VwdGFibGUiCiAgICBoaWdoID0gImhpZ2giCiAgICBsaW1pdGVkID0gImxpbWl0ZWQiCiAgICBtaW5pbWFsID0gIm1pbmltYWwiCgoKQHNtaXRoZXJ5LnNlcnZlcigpCmRlZiBjcmVhdGVfc2VydmVyKCk6CiAgICAiIiJDcmVhdGUgYW5kIHJldHVybiB0aGUgRVUgQUkgQWN0IENvbXBsaWFuY2UgQ2hlY2tlciBNQ1Agc2VydmVyLiIiIgogICAgbWNwID0gRmFzdE1DUCgKICAgICAgICBuYW1lPSJFVSBBSSBBY3QgQ29tcGxpYW5jZSBDaGVja2VyIiwKICAgICAgICBpbnN0cnVjdGlvbnM9IlNjYW4gcHJvamVjdHMgdG8gZGV0ZWN0IEFJIG1vZGVsIHVzYWdlIGFuZCB2ZXJpZnkgRVUgQUkgQWN0IGNvbXBsaWFuY2UiLAogICAgICAgIGhvc3Q9IjAuMC4wLjAiLAogICAgICAgIHBvcnQ9ODA4OSwKICAgICkKCiAgICBAbWNwLnRvb2woKQogICAgZGVmIHNjYW5fcHJvamVjdChwcm9qZWN0X3BhdGg6IHN0cikgLT4gZGljdDoKICAgICAgICAiIiJTY2FuIGEgcHJvamVjdCB0byBkZXRlY3QgQUkgbW9kZWwgdXNhZ2UgKE9wZW5BSSwgQW50aHJvcGljLCBIdWdnaW5nRmFjZSwgVGVuc29yRmxvdywgUHlUb3JjaCwgTGFuZ0NoYWluKS4KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcHJvamVjdF9wYXRoOiBBYnNvbHV0ZSBwYXRoIHRvIHRoZSBwcm9qZWN0IHRvIHNjYW4KICAgICAgICAiIiIKICAgICAgICBpc19zYWZlLCBlcnJvcl9tc2cgPSBfdmFsaWRhdGVfcHJvamVjdF9wYXRoKHByb2plY3RfcGF0aCkKICAgICAgICBpZiBub3QgaXNfc2FmZToKICAgICAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiBlcnJvcl9tc2csICJkZXRlY3RlZF9tb2RlbHMiOiB7fX0KICAgICAgICBjaGVja2VyID0gRVVBSUFjdENoZWNrZXIocHJvamVjdF9wYXRoKQogICAgICAgIHJldHVybiBjaGVja2VyLnNjYW5fcHJvamVjdCgpCgogICAgQG1jcC50b29sKCkKICAgIGRlZiBjaGVja19jb21wbGlhbmNlKHByb2plY3RfcGF0aDogc3RyLCByaXNrX2NhdGVnb3J5OiBSaXNrQ2F0ZWdvcnkgPSBSaXNrQ2F0ZWdvcnkubGltaXRlZCkgLT4gZGljdDoKICAgICAgICAiIiJDaGVjayBFVSBBSSBBY3QgY29tcGxpYW5jZSBmb3IgYSBnaXZlbiByaXNrIGNhdGVnb3J5LgoKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm9qZWN0X3BhdGg6IEFic29sdXRlIHBhdGggdG8gdGhlIHByb2plY3QKICAgICAgICAgICAgcmlza19jYXRlZ29yeTogRVUgQUkgQWN0IHJpc2sgY2F0ZWdvcnkgKHVuYWNjZXB0YWJsZSwgaGlnaCwgbGltaXRlZCwgbWluaW1hbCkKICAgICAgICAiIiIKICAgICAgICBpc19zYWZlLCBlcnJvcl9tc2cgPSBfdmFsaWRhdGVfcHJvamVjdF9wYXRoKHByb2plY3RfcGF0aCkKICAgICAgICBpZiBub3QgaXNfc2FmZToKICAgICAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiBlcnJvcl9tc2d9CiAgICAgICAgY2hlY2tlciA9IEVVQUlBY3RDaGVja2VyKHByb2plY3RfcGF0aCkKICAgICAgICBjaGVja2VyLnNjYW5fcHJvamVjdCgpCiAgICAgICAgcmV0dXJuIGNoZWNrZXIuY2hlY2tfY29tcGxpYW5jZShyaXNrX2NhdGVnb3J5LnZhbHVlKQoKICAgIEBtY3AudG9vbCgpCiAgICBkZWYgZ2VuZXJhdGVfcmVwb3J0KHByb2plY3RfcGF0aDogc3RyLCByaXNrX2NhdGVnb3J5OiBSaXNrQ2F0ZWdvcnkgPSBSaXNrQ2F0ZWdvcnkubGltaXRlZCkgLT4gZGljdDoKICAgICAgICAiIiJHZW5lcmF0ZSBhIGNvbXBsZXRlIEVVIEFJIEFjdCBjb21wbGlhbmNlIHJlcG9ydCB3aXRoIHNjYW4gcmVzdWx0cywgY29tcGxpYW5jZSBjaGVja3MsIGFuZCByZWNvbW1lbmRhdGlvbnMuCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHByb2plY3RfcGF0aDogQWJzb2x1dGUgcGF0aCB0byB0aGUgcHJvamVjdAogICAgICAgICAgICByaXNrX2NhdGVnb3J5OiBFVSBBSSBBY3QgcmlzayBjYXRlZ29yeSAodW5hY2NlcHRhYmxlLCBoaWdoLCBsaW1pdGVkLCBtaW5pbWFsKQogICAgICAgICIiIgogICAgICAgIGlzX3NhZmUsIGVycm9yX21zZyA9IF92YWxpZGF0ZV9wcm9qZWN0X3BhdGgocHJvamVjdF9wYXRoKQogICAgICAgIGlmIG5vdCBpc19zYWZlOgogICAgICAgICAgICByZXR1cm4geyJlcnJvciI6IGVycm9yX21zZ30KICAgICAgICBjaGVja2VyID0gRVVBSUFjdENoZWNrZXIocHJvamVjdF9wYXRoKQogICAgICAgIHNjYW5fcmVzdWx0cyA9IGNoZWNrZXIuc2Nhbl9wcm9qZWN0KCkKICAgICAgICBjb21wbGlhbmNlX3Jlc3VsdHMgPSBjaGVja2VyLmNoZWNrX2NvbXBsaWFuY2Uocmlza19jYXRlZ29yeS52YWx1ZSkKICAgICAgICByZXR1cm4gY2hlY2tlci5nZW5lcmF0ZV9yZXBvcnQoc2Nhbl9yZXN1bHRzLCBjb21wbGlhbmNlX3Jlc3VsdHMpCgogICAgcmV0dXJuIG1jcAoKCiMgTGVnYWN5IGludGVyZmFjZSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eQpjbGFzcyBNQ1BTZXJ2ZXI6CiAgICAiIiJMZWdhY3kgTUNQIFNlcnZlciBpbnRlcmZhY2UgKHVzZSBjcmVhdGVfc2VydmVyKCkgZm9yIE1DUCBwcm90b2NvbCkiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5fdG9vbHMgPSB7CiAgICAgICAgICAgICJzY2FuX3Byb2plY3QiOiBsYW1iZGEgKipwYXJhbXM6IHsidG9vbCI6ICJzY2FuX3Byb2plY3QiLCAicmVzdWx0cyI6IEVVQUlBY3RDaGVja2VyKHBhcmFtc1sicHJvamVjdF9wYXRoIl0pLnNjYW5fcHJvamVjdCgpfSwKICAgICAgICAgICAgImNoZWNrX2NvbXBsaWFuY2UiOiBsYW1iZGEgKipwYXJhbXM6IHsidG9vbCI6ICJjaGVja19jb21wbGlhbmNlIiwgInJlc3VsdHMiOiAobGFtYmRhIGM6IChjLnNjYW5fcHJvamVjdCgpLCBjLmNoZWNrX2NvbXBsaWFuY2UocGFyYW1zLmdldCgicmlza19jYXRlZ29yeSIsICJsaW1pdGVkIikpKVstMV0pKEVVQUlBY3RDaGVja2VyKHBhcmFtc1sicHJvamVjdF9wYXRoIl0pKX0sCiAgICAgICAgICAgICJnZW5lcmF0ZV9yZXBvcnQiOiBsYW1iZGEgKipwYXJhbXM6IHsidG9vbCI6ICJnZW5lcmF0ZV9yZXBvcnQiLCAicmVzdWx0cyI6IChsYW1iZGEgYzogYy5nZW5lcmF0ZV9yZXBvcnQoYy5zY2FuX3Byb2plY3QoKSwgYy5jaGVja19jb21wbGlhbmNlKHBhcmFtcy5nZXQoInJpc2tfY2F0ZWdvcnkiLCAibGltaXRlZCIpKSkpKEVVQUlBY3RDaGVja2VyKHBhcmFtc1sicHJvamVjdF9wYXRoIl0pKX0sCiAgICAgICAgfQoKICAgIGRlZiBoYW5kbGVfcmVxdWVzdChzZWxmLCB0b29sX25hbWU6IHN0ciwgcGFyYW1zOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgaWYgdG9vbF9uYW1lIG5vdCBpbiBzZWxmLl90b29sczoKICAgICAgICAgICAgcmV0dXJuIHsiZXJyb3IiOiBmIlVua25vd24gdG9vbDoge3Rvb2xfbmFtZX0iLCAiYXZhaWxhYmxlX3Rvb2xzIjogbGlzdChzZWxmLl90b29scy5rZXlzKCkpfQogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3Rvb2xzW3Rvb2xfbmFtZV0oKipwYXJhbXMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geyJlcnJvciI6IGYiRXJyb3IgZXhlY3V0aW5nIHt0b29sX25hbWV9OiB7c3RyKGUpfSJ9CgogICAgZGVmIGxpc3RfdG9vbHMoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgcmV0dXJuIHsidG9vbHMiOiBbCiAgICAgICAgICAgIHsibmFtZSI6ICJzY2FuX3Byb2plY3QiLCAiZGVzY3JpcHRpb24iOiAiU2NhbiBhIHByb2plY3QgdG8gZGV0ZWN0IEFJIG1vZGVsIHVzYWdlIiwgInBhcmFtZXRlcnMiOiB7InByb2plY3RfcGF0aCI6ICJzdHJpbmcgKHJlcXVpcmVkKSJ9fSwKICAgICAgICAgICAgeyJuYW1lIjogImNoZWNrX2NvbXBsaWFuY2UiLCAiZGVzY3JpcHRpb24iOiAiQ2hlY2sgRVUgQUkgQWN0IGNvbXBsaWFuY2UiLCAicGFyYW1ldGVycyI6IHsicHJvamVjdF9wYXRoIjogInN0cmluZyAocmVxdWlyZWQpIiwgInJpc2tfY2F0ZWdvcnkiOiAic3RyaW5nIChvcHRpb25hbCkifX0sCiAgICAgICAgICAgIHsibmFtZSI6ICJnZW5lcmF0ZV9yZXBvcnQiLCAiZGVzY3JpcHRpb24iOiAiR2VuZXJhdGUgYSBjb21wbGV0ZSBjb21wbGlhbmNlIHJlcG9ydCIsICJwYXJhbWV0ZXJzIjogeyJwcm9qZWN0X3BhdGgiOiAic3RyaW5nIChyZXF1aXJlZCkiLCAicmlza19jYXRlZ29yeSI6ICJzdHJpbmcgKG9wdGlvbmFsKSJ9fSwKICAgICAgICBdfQoKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBpbXBvcnQgc3lzCiAgICBzZXJ2ZXIgPSBjcmVhdGVfc2VydmVyKCkKICAgIHRyYW5zcG9ydCA9ICJzdHJlYW1hYmxlLWh0dHAiIGlmICItLWh0dHAiIGluIHN5cy5hcmd2IGVsc2UgInN0ZGlvIgogICAgc2VydmVyLnJ1bih0cmFuc3BvcnQ9dHJhbnNwb3J0KQo=";

const tmpDir = fs.mkdtempSync(path.join(os.tmpdir(), "mcp-eu-ai-act-"));
const tmpServer = path.join(tmpDir, "server.py");
fs.writeFileSync(tmpServer, Buffer.from(SERVER_PY_B64, "base64").toString("utf-8"));

const server = spawn("python3", [tmpServer], { stdio: "inherit" });

function cleanup() {
  try { fs.unlinkSync(tmpServer); } catch {}
  try { fs.rmdirSync(tmpDir); } catch {}
}

server.on("error", (err) => { console.error("MCP server error:", err.message); cleanup(); process.exit(1); });
server.on("close", (code) => { cleanup(); process.exit(code || 0); });
process.on("SIGTERM", () => server.kill());
process.on("SIGINT", () => server.kill());
